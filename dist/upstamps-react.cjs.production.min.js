"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),n=e(t),r=e(require("localforage")),o=e(require("lodash.isequal"));function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function a(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var s="https://services.upstamps.com/api",u=t.createContext({}),c=function(e,t){switch(t.type){case"set-flags":case"set-flags-error":case"set-remotes":case"set-remotes-error":return i({},e,{},t.payload);default:throw new Error("Unhandled action type")}},l=function(){var e=t.useContext(u);if(void 0===e)throw new Error("UpStampsContext must be used with UpStampsProvider!");return e},f=["A","B"],m=function(e,t){try{return Promise.resolve(a((function(){return Promise.resolve(fetch(e)).then((function(e){return Promise.resolve(e.json()).then((function(e){var n=e.ABTesting.filter((function(e){return e.name===t})).length>0,r=Math.floor(Math.random()*f.length);return{show:n,variant:f[r],loading:!1}}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},h=function(e,t,n){return Promise.resolve(a((function(){return Promise.resolve(fetch(n,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:JSON.stringify({name:t,varA:"A"===e?1:0,varB:"B"===e?1:0})})).then((function(e){return Promise.resolve(e.json())}))}),(function(e){return e})))},v=n.forwardRef((function(e,r){return n.useImperativeHandle(r,(function(){return{emitter:e.emitter}})),n.createElement(t.Fragment,null,e.children)})),d=function(e){var o=e.children,u=e.name,c=e.testRef,f=e.localStorage,d=void 0!==f&&f,p=l(),g=t.useState({component:[],loading:!0,error:!1,variant:"A",show:!1}),y=g[0],P=g[1],w=p.state.params,S=s+"/"+w.clientId+"/"+w.projectKey+"/"+w.envKey+"/testing",j=function(e){var t=n.Children.map(o,(function(t){if(t.props.name===e)return t}));P((function(e){return i({},e,{component:t})}))};return t.useEffect((function(){!function(){try{var e=a((function(){return Promise.resolve(r.getItem(u)).then((function(e){var t=function(){if(!d||null===e)return console.log("ABTest remote"),Promise.resolve(m(S,u)).then((function(e){var t=e.show,n=e.loading,o=e.variant;return j(o),P((function(e){return i({},e,{show:t,variant:o,loading:n})})),Promise.resolve(r.setItem(u,{show:t,variant:o,loading:n})).then((function(){}))}));console.log("ABTest local"),j(e.variant),P((function(t){return i({},t,{},e)}))}();if(t&&t.then)return t.then((function(){}))}))}),(function(){P((function(e){return i({},e,{error:!0,loading:!1})}))}));Promise.resolve(e&&e.then?e.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[u,p.state.params]),y.loading||y.show?n.createElement(v,{ref:c,emitter:function(){return Promise.resolve(a((function(){return Promise.resolve(h(y.variant,u,S))}),(function(e){return e})))}},y.component):null},p=function(e){var r=e.children,o=e.name;return n.cloneElement(n.createElement(t.Fragment,null),{name:o},n.createElement(t.Fragment,null,r))};p.displayName="ABTest.Variant",d.Variant=p;var g=function(e,t,n){try{return Promise.resolve(a((function(){var r=function(e){var t=encodeURIComponent;return Object.keys(e).filter((function(t){return void 0!==e[t]&&e[t]&&null!==e[t]})).map((function(n){return t(n)+"="+t(e[n])})).join("&")}({name:t,country:n.country,client:n.client,clientType:n.clientType});return Promise.resolve(fetch(e+"?"+r,{method:"GET"})).then((function(e){return Promise.resolve(e.json()).then((function(e){var t=e.segment;return{segment:t,show:t.length>0,loading:!1}}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},y=t.createContext({}),P=function(e,t){switch(t.type){case"set-scope":case"set-scope-error":return i({},e,{},t.payload);default:throw new Error("Unhandled action type")}};exports.ABTest=d,exports.Flag=function(e){var r=e.children,o=e.name,i=l().state;return t.useMemo((function(){return-1!==i.flags.indexOf(o)}),[i.flags,o])?n.createElement(t.Fragment,null,r):null},exports.RemoteFlag=function(e){var r=e.children,o=e.name,i=l().state,a=t.useMemo((function(){return i.remotes.filter((function(e){return e.name===o}))}),[i.remotes,o]),s=t.useMemo((function(){return a.length>0}),[a]);return s?n.createElement(t.Fragment,null,r(s?a[0].data:{})):null},exports.ScopesContext=y,exports.ScopesProvider=function(e){var r=e.children,o=e.name,i=e.email,u=l(),c=t.useReducer(P,{loading:!0,error:!1,params:{name:o,email:i}}),f=c[0],m=c[1],h=u.state.params,v=h.clientId,d=h.projectKey,p=t.useMemo((function(){return{state:f,dispatch:m}}),[f,m]);return t.useEffect((function(){var e=!1;return window.localStorage.getItem("upstamps_scope_email")!==i&&function(){try{var t=a((function(){return Promise.resolve(fetch(s+"/"+v+"/"+d+"/scopes/add",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:JSON.stringify({name:o,email:i})})).then((function(){window.localStorage.setItem("upstamps_scope_email",i),e||m({type:"set-scope",payload:{success:!0,loading:!1}})}))}),(function(){m({type:"set-scope-error",payload:{loading:!1,error:!0}})}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}(),function(){e=!0}}),[i]),n.createElement(y.Provider,{value:p},r)},exports.Segment=function(e){var u=e.children,c=e.name,f=e.params,m=e.localStorage,h=void 0!==m&&m,v=l(),d=t.useState({loading:!0,error:!1,show:!1}),p=d[0],y=d[1],P=v.state.params,w=s+"/"+P.clientId+"/"+P.projectKey+"/"+P.envKey+"/segment";return t.useEffect((function(){!function(){try{var e=a((function(){return Promise.resolve(r.getItem(c)).then((function(e){var t=function(){if(!h||null===e)return Promise.resolve(g(w,c,f)).then((function(e){var t=e.show,n=e.loading;return console.log("Segment remote"),y((function(e){return i({},e,{show:t,loading:n})})),Promise.resolve(r.setItem(c,{show:t,loading:n,params:f})).then((function(){}))}));console.log("Segment local = "),y((function(t){return i({},t,{show:o(f,e.params),loading:!1})}))}();if(t&&t.then)return t.then((function(){}))}))}),(function(){y((function(e){return i({},e,{error:!0,loading:!1})}))}));Promise.resolve(e&&e.then?e.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[c,v.state.params]),p.show?n.createElement(t.Fragment,null,u):null},exports.UpStampsContext=u,exports.UpStampsProvider=function(e){var o=e.children,i=e.clientId,l=e.envKey,f=e.projectKey,m=t.useReducer(c,{loading:!0,error:!1,flags:[],remotes:[],params:{clientId:i,envKey:l,projectKey:f}}),h=m[0],v=m[1],d=t.useMemo((function(){return{state:h,dispatch:v}}),[h,v]);return t.useEffect((function(){var e=!1;return function(){try{Promise.resolve(a((function(){if(!(h.flags.length>0))return Promise.resolve(fetch(s+"/"+i+"/"+f+"/"+l+"/flags")).then((function(t){return Promise.resolve(t.json()).then((function(t){var n=t.flags.map((function(e){return e.name})),o=function(){if(!e)return v({type:"set-flags",payload:{flags:n,loading:!1}}),Promise.resolve(r.setItem("flags",n)).then((function(){}))}();if(o&&o.then)return o.then((function(){}))}))}))}),(function(){v({type:"set-flags-error",payload:{loading:!1,error:!0}})})))}catch(e){return Promise.reject(e)}}(),function(){try{Promise.resolve(a((function(){if(!(h.remotes.length>0))return Promise.resolve(fetch(s+"/"+i+"/"+f+"/"+l+"/remotes")).then((function(t){return Promise.resolve(t.json()).then((function(t){var n=t.remotes,o=function(){if(!e)return v({type:"set-remotes",payload:{remotes:n,loading:!1}}),Promise.resolve(r.setItem("remotes",n)).then((function(){}))}();if(o&&o.then)return o.then((function(){}))}))}))}),(function(){v({type:"set-remotes-error",payload:{loading:!1,error:!0}})})))}catch(e){return Promise.reject(e)}}(),function(){e=!0}}),[]),n.createElement(u.Provider,{value:d},o)},exports.useABTest=function(e,n){void 0===n&&(n=!1);var o=l(),u=t.useState({loading:!0,error:!1,show:!1,variant:"A"}),c=u[0],f=u[1],v=o.state.params,d=s+"/"+v.clientId+"/"+v.projectKey+"/"+v.envKey+"/testing";return t.useEffect((function(){!function(){try{var t=a((function(){return Promise.resolve(r.getItem(e)).then((function(t){var o=function(){if(!n||null===t)return console.log("useABTest remote"),Promise.resolve(m(d,e)).then((function(t){var n=t.show,o=t.loading,a=t.variant;return f((function(e){return i({},e,{show:n,variant:a,loading:o})})),Promise.resolve(r.setItem(e,{show:n,variant:a,loading:o})).then((function(){}))}));console.log("useABTest local"),f((function(e){return i({},e,{},t)}))}();if(o&&o.then)return o.then((function(){}))}))}),(function(){f((function(e){return i({},e,{error:!0,loading:!1})}))}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[e,o.state.params]),{show:c.show,error:c.error,loading:c.loading,variant:c.variant,emitter:function(){return Promise.resolve(a((function(){return Promise.resolve(h(c.variant,e,d))}),(function(e){return e})))}}},exports.useFlag=function(e){var n=l().state;return{show:-1!==t.useMemo((function(){return n.flags}),[n.flags]).indexOf(e)}},exports.useRemoteFlag=function(e){var n=l().state,r=t.useMemo((function(){return n.remotes.filter((function(t){return t.name===e}))}),[n.remotes,e]),o=t.useMemo((function(){return r.length>0}),[r]);return{show:o,data:o?r[0].data:{}}},exports.useSegment=function(e,n,u){void 0===u&&(u=!1);var c=l(),f=t.useState({loading:!0,error:!1,show:!1}),m=f[0],h=f[1],v=c.state.params,d=s+"/"+v.clientId+"/"+v.projectKey+"/"+v.envKey+"/segment";return t.useEffect((function(){!function(){try{var t=a((function(){return Promise.resolve(r.getItem(e)).then((function(t){var a=function(){if(!u||null===t)return Promise.resolve(g(d,e,n)).then((function(t){var o=t.show,a=t.loading;return console.log("useSegment remote"),h((function(e){return i({},e,{show:o,loading:a})})),Promise.resolve(r.setItem(e,{show:o,loading:a,params:n})).then((function(){}))}));console.log("useSegment local"),h((function(e){return i({},e,{show:o(n,t.params),loading:!1})}))}();if(a&&a.then)return a.then((function(){}))}))}),(function(){h((function(e){return i({},e,{error:!0,loading:!1})}))}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[e,c.state.params]),{show:m.show,error:m.error,loading:m.loading}};
//# sourceMappingURL=upstamps-react.cjs.production.min.js.map
