"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("react"),r=(e=t)&&"object"==typeof e&&"default"in e?e.default:e;function n(){return(n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function o(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var a="https://services.upstamps.com/api",i=t.createContext({}),s=function(e,t){switch(t.type){case"set-flags":case"set-flags-error":case"set-remotes":case"set-remotes-error":return n({},e,{},t.payload);default:throw new Error("Unhandled action type")}},u=function(){var e=t.useContext(i);if(void 0===e)throw new Error("UpStampsContext must be used with UpStampsProvider!");return e},c=["A","B"],l=function(e,t){try{return Promise.resolve(o((function(){return Promise.resolve(fetch(e)).then((function(e){return Promise.resolve(e.json()).then((function(e){var r=e.ABTesting.filter((function(e){return e.name===t})).length>0,n=Math.floor(Math.random()*c.length);return{show:r,variant:c[n],loading:!1}}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},f=function(e,t,r){return Promise.resolve(o((function(){return Promise.resolve(fetch(r,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:JSON.stringify({name:t,varA:"A"===e?1:0,varB:"B"===e?1:0})})).then((function(e){return Promise.resolve(e.json())}))}),(function(e){return e})))},m=r.forwardRef((function(e,n){return r.useImperativeHandle(n,(function(){return{emitter:e.emitter}})),r.createElement(t.Fragment,null,e.children)})),d=function(e){var i=e.children,s=e.name,c=e.testRef,d=u(),p=t.useState({component:[],loading:!0,error:!1,variant:"A"}),v=p[0],h=p[1],g=d.state.params,y=a+"/"+g.clientId+"/"+g.projectKey+"/"+g.envKey+"/testing";return t.useEffect((function(){!function(){try{var e=o((function(){return Promise.resolve(l(y,s)).then((function(e){var t=e.show,o=e.loading,a=e.variant;!function(e){var t=r.Children.map(i,(function(t){if(t.props.name===e)return t}));h((function(e){return n({},e,{component:t})}))}(a),h((function(e){return n({},e,{show:t,variant:a,loading:o})}))}))}),(function(){h((function(e){return n({},e,{error:!0,loading:!1})}))}));Promise.resolve(e&&e.then?e.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[s,d.state.params]),r.createElement(m,{ref:c,emitter:function(){return Promise.resolve(o((function(){return Promise.resolve(f(v.variant,s,y))}),(function(e){return e})))}},v.component)},p=function(e){var n=e.children,o=e.name;return r.cloneElement(r.createElement(t.Fragment,null),{name:o},r.createElement(t.Fragment,null,n))};p.displayName="ABTest.Variant",d.Variant=p;var v=function(e,t,r){try{return Promise.resolve(o((function(){var n=function(e){var t=encodeURIComponent;return Object.keys(e).filter((function(t){return void 0!==e[t]&&e[t]&&null!==e[t]})).map((function(r){return t(r)+"="+t(e[r])})).join("&")}({name:t,country:r.country,client:r.client,clientType:r.clientType});return Promise.resolve(fetch(e+"?"+n,{method:"GET"})).then((function(e){return Promise.resolve(e.json()).then((function(e){var t=e.segment;return{segment:t,show:t.length>0,loading:!1}}))}))}),(function(e){throw e})))}catch(e){return Promise.reject(e)}},h=t.createContext({}),g=function(e,t){switch(t.type){case"set-scope":case"set-scope-error":return n({},e,{},t.payload);default:throw new Error("Unhandled action type")}};exports.ABTest=d,exports.Flag=function(e){var n=e.children,o=e.name,a=u().state;return t.useMemo((function(){return-1!==a.flags.indexOf(o)}),[a.flags,o])?r.createElement(t.Fragment,null,n):null},exports.RemoteFlag=function(e){var n=e.children,o=e.name,a=u().state,i=t.useMemo((function(){return a.remotes.filter((function(e){return e.name===o}))}),[a.remotes,o]),s=t.useMemo((function(){return i.length>0}),[i]);return s?r.createElement(t.Fragment,null,n(s?i[0].data:{})):null},exports.ScopesContext=h,exports.ScopesProvider=function(e){var n=e.children,i=e.name,s=e.email,c=u(),l=t.useReducer(g,{loading:!0,error:!1,params:{name:i,email:s}}),f=l[0],m=l[1],d=c.state.params,p=d.clientId,v=d.projectKey,y=t.useMemo((function(){return{state:f,dispatch:m}}),[f,m]);return t.useEffect((function(){var e=!1,t=window.localStorage.getItem("upstamps_scope_email");return null===t||t===s||function(){try{var t=o((function(){return Promise.resolve(fetch(a+"/"+p+"/"+v+"/scopes/add",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:JSON.stringify({name:i,email:s})})).then((function(){window.localStorage.setItem("upstamps_scope_email",s),e||m({type:"set-scope",payload:{success:!0,loading:!1}})}))}),(function(){m({type:"set-scope-error",payload:{loading:!1,error:!0}})}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}(),function(){e=!0}}),[s]),r.createElement(h.Provider,{value:y},n)},exports.Segment=function(e){var i=e.children,s=e.name,c=e.params,l=u(),f=t.useState({loading:!0,error:!1,show:!1}),m=f[0],d=f[1],p=l.state.params,h=a+"/"+p.clientId+"/"+p.projectKey+"/"+p.envKey+"/segment";return t.useEffect((function(){!function(){try{var e=o((function(){return Promise.resolve(v(h,s,c)).then((function(e){var t=e.show,r=e.loading;d((function(e){return n({},e,{show:t,loading:r})}))}))}),(function(){d((function(e){return n({},e,{error:!0,loading:!1})}))}));Promise.resolve(e&&e.then?e.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[s,l.state.params]),m.show?r.createElement(t.Fragment,null,i):null},exports.UpStampsContext=i,exports.UpStampsProvider=function(e){var n=e.children,u=e.clientId,c=e.envKey,l=e.projectKey,f=t.useReducer(s,{loading:!0,error:!1,flags:[],remotes:[],params:{clientId:u,envKey:c,projectKey:l}}),m=f[0],d=f[1],p=t.useMemo((function(){return{state:m,dispatch:d}}),[m,d]);return t.useEffect((function(){var e=!1;return function(){try{Promise.resolve(o((function(){if(!(m.flags.length>0))return Promise.resolve(fetch(a+"/"+u+"/"+l+"/"+c+"/flags")).then((function(t){return Promise.resolve(t.json()).then((function(t){var r=t.flags.map((function(e){return e.name}));e||d({type:"set-flags",payload:{flags:r,loading:!1}})}))}))}),(function(){d({type:"set-flags-error",payload:{loading:!1,error:!0}})})))}catch(e){return Promise.reject(e)}}(),function(){try{Promise.resolve(o((function(){if(!(m.remotes.length>0))return Promise.resolve(fetch(a+"/"+u+"/"+l+"/"+c+"/remotes")).then((function(t){return Promise.resolve(t.json()).then((function(t){e||d({type:"set-remotes",payload:{remotes:t.remotes,loading:!1}})}))}))}),(function(){d({type:"set-remotes-error",payload:{loading:!1,error:!0}})})))}catch(e){return Promise.reject(e)}}(),function(){e=!0}}),[m.flags,m.remotes,u,c,l]),r.createElement(i.Provider,{value:p},n)},exports.useABTest=function(e){var r=u(),i=t.useState({loading:!0,error:!1,show:!1,variant:"A"}),s=i[0],c=i[1],m=r.state.params,d=a+"/"+m.clientId+"/"+m.projectKey+"/"+m.envKey+"/testing";return t.useEffect((function(){!function(){try{var t=o((function(){return Promise.resolve(l(d,e)).then((function(e){var t=e.show,r=e.loading,o=e.variant;c((function(e){return n({},e,{show:t,variant:o,loading:r})}))}))}),(function(){c((function(e){return n({},e,{error:!0,loading:!1})}))}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[e,r.state.params]),{show:s.show,error:s.error,loading:s.loading,variant:s.variant,emitter:function(){return Promise.resolve(o((function(){return Promise.resolve(f(s.variant,e,d))}),(function(e){return e})))}}},exports.useFlag=function(e){var r=u().state;return{show:-1!==t.useMemo((function(){return r.flags}),[r.flags]).indexOf(e)}},exports.useRemoteFlag=function(e){var r=u().state,n=t.useMemo((function(){return r.remotes.filter((function(t){return t.name===e}))}),[r.remotes,e]),o=t.useMemo((function(){return n.length>0}),[n]);return{show:o,data:o?n[0].data:{}}},exports.useSegment=function(e,r){var i=u(),s=t.useState({loading:!0,error:!1,show:!1}),c=s[0],l=s[1],f=i.state.params,m=a+"/"+f.clientId+"/"+f.projectKey+"/"+f.envKey+"/segment";return t.useEffect((function(){!function(){try{var t=o((function(){return Promise.resolve(v(m,e,r)).then((function(e){var t=e.show,r=e.loading;l((function(e){return n({},e,{show:t,loading:r})}))}))}),(function(){l((function(e){return n({},e,{error:!0,loading:!1})}))}));Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}()}),[e,i.state.params]),{show:c.show,error:c.error,loading:c.loading}};
//# sourceMappingURL=upstamps-react.cjs.production.min.js.map
